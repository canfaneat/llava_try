#!/bin/bash

SPLIT="mmbench_dev_20230712"
OFFICIAL_DATA_URL="https://github.com/InternLM/MMBench/releases/download/v1.0.0/mmbench_dev_20230712.tsv"
DATA_DIR="/kaggle/working/mmbench_data"
OFFICIAL_TSV_PATH="$DATA_DIR/$SPLIT.tsv"

# Create data directory and download official MMBench dev file if it doesn't exist
mkdir -p "$DATA_DIR"
if [ ! -f "$OFFICIAL_TSV_PATH" ]; then
    echo "Downloading official MMBench dev data from $OFFICIAL_DATA_URL..."
    wget -O "$OFFICIAL_TSV_PATH" "$OFFICIAL_DATA_URL"
    if [ $? -ne 0 ]; then
        echo "Error downloading MMBench data. Please check URL or network connection."
        exit 1
    fi
else
    echo "Official MMBench dev data already exists at $OFFICIAL_TSV_PATH."
fi

# --- Output Filename Handling ---
# Get the --model-path argument value
MODEL_ARG_VALUE="unknown_model"
for arg in "$@"; do
  case $arg in
    --model-path=*) # Handles --model-path=value
      MODEL_ARG_VALUE="${arg#*=}"
      shift # Remove --model-path=value from processing
      ;;
    --model-path) # Handles --model-path value
      MODEL_ARG_VALUE="$2"
      shift # Remove --model-path
      shift # Remove value
      ;;
  esac
done

# Create a filename-safe checkpoint name from the model path/ID
# Replace / with _ and remove potential trailing /
CKPT=$(echo "$MODEL_ARG_VALUE" | sed 's|/|_|g' | sed 's/_$//')
echo "Using model identifier: $MODEL_ARG_VALUE"
echo "Generated checkpoint name for output files: $CKPT"
# ---

OUTPUT_DIR="/kaggle/working/output"
ANSWERS_DIR="$OUTPUT_DIR/answers/$SPLIT"
UPLOAD_DIR="$OUTPUT_DIR/answers_upload/$SPLIT"
mkdir -p "$ANSWERS_DIR"
mkdir -p "$UPLOAD_DIR"

# Run the evaluation using the official downloaded TSV file
python -m llava.eval.model_vqa_mmbench \
    --question-file "$OFFICIAL_TSV_PATH" \
    --answers-file "$ANSWERS_DIR/$CKPT.jsonl" \
    --single-pred-prompt \
    --temperature 0.7 \
    "$@" # Pass remaining script arguments (including --model-path, --model-base etc.)

# Check if the answers file was created before attempting conversion
if [ ! -f "$ANSWERS_DIR/$CKPT.jsonl" ]; then
    echo "Error: Answers file $ANSWERS_DIR/$CKPT.jsonl was not generated by the evaluation script."
    exit 1
fi

# Run the conversion script using the official downloaded TSV file
python scripts/convert_mmbench_for_submission.py \
    --annotation-file "$OFFICIAL_TSV_PATH" \
    --result-dir "$ANSWERS_DIR" \
    --upload-dir "$UPLOAD_DIR" \
    --experiment "$CKPT"